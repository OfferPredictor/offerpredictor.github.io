<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>美本录取率预测（中国学生版）</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input, select {
            width: 200px;
            padding: 5px;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .good {
            background-color: #d4edda;
            color: #155724;
        }
        .medium {
            background-color: #fff3cd;
            color: #856404;
        }
        .low {
            background-color: #f8d7da;
            color: #721c24;
        }
        .warning {
            background-color: #ffeeba;
            border-left: 4px solid #ffc107;
        }
        /* 新增的语言考试选择样式 */
        .language-test-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .language-test-group label {
            display: inline-flex;
            align-items: center;
            margin-bottom: 0;
            cursor: pointer;
        }
        .language-test-group input[type="radio"] {
            width: auto;
            margin-right: 5px;
        }
        /* 新增的课程输入样式 */
        .course-input-group {
            margin-bottom: 15px;
        }
        .course-input {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .course-input input,
        .course-input select {
            width: 150px;
            margin-right: 10px;
        }
        .remove-course {
            padding: 5px 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
        }
        .remove-course:hover {
            background-color: #c82333;
        }
        /* 添加历史记录表格样式 */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            display: none;
        }
        .history-table th, .history-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .history-table th {
            background-color: #f2f2f2;
        }
        .history-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .history-table tr:hover {
            background-color: #f1f1f1;
        }
        #historyButton {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        #historyButton:hover {
            background-color: #0056b3;
        }
        .clear-history {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
        }
        .clear-history:hover {
            background-color: #c82333;
        }
        /* 添加数据库相关样式 */
        .db-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .db-button {
            padding: 8px 15px;
            background-color: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
        }
        .db-button:hover {
            background-color: #5a6268;
        }
        .export-button {
            background-color: #28a745;
        }
        .export-button:hover {
            background-color: #218838;
        }
        .stats-button {
            background-color: #17a2b8;
        }
        .stats-button:hover {
            background-color: #138496;
        }
        .stats-panel {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        /* 添加导出日志按钮样式 */
        .export-logs {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            margin-left: 10px;
        }
        .export-logs:hover {
            background-color: #218838;
        }
        /* 添加进度条样式 */
        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 30px;
            background-color: #4CAF50;
            text-align: center;
            line-height: 30px;
            color: white;
            transition: width 0.5s ease-in-out;
        }
        .result-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .result-detail {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .result-label {
            font-weight: bold;
            color: #666;
        }
        .result-value {
            color: #333;
        }
        .result-advice {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
            background-color: #e3f2fd;
        }
        /* 添加预测录取率的特殊样式 */
        .prediction-rate {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
    </style>
</head>
<body>
    <h2>美本录取率预测（中国学生版）</h2>
    
    <div class="form-group">
        <label>语言考试:</label>
        <div class="language-test-group">
            <label for="toefl_radio">
                <input type="radio" id="toefl_radio" name="language_test" value="toefl" checked>
                托福
            </label>
            <label for="ielts_radio">
                <input type="radio" id="ielts_radio" name="language_test" value="ielts">
                雅思
            </label>
        </div>
    </div>

    <div class="form-group" id="toefl_group">
        <label for="toefl">托福成绩 (0-120):</label>
        <input type="number" id="toefl" min="0" max="120" required>
    </div>

    <div class="form-group" id="ielts_group" style="display: none;">
        <label for="ielts">雅思成绩 (0-9):</label>
        <input type="number" id="ielts" min="0" max="9" step="0.5" required>
    </div>

    <div class="form-group">
        <label for="gpa">GPA (0-4.0):</label>
        <input type="number" id="gpa" min="0" max="4" step="0.01" required>
    </div>

    <div class="form-group">
        <label for="curriculum">课程体系:</label>
        <select id="curriculum" required onchange="updateCourseInputs()">
            <option value="ap">AP课程</option>
            <option value="ib">IB课程</option>
            <option value="a_level">A-Level课程</option>
            <option value="domestic">国内课程</option>
            <option value="other">其他国际课程</option>
        </select>
    </div>

    <!-- AP课程成绩输入 -->
    <div id="ap_courses" class="course-input-group">
        <div class="form-group">
            <label>AP课程成绩 (1-5):</label>
            <div class="course-inputs">
                <div class="course-input">
                    <input type="number" class="ap-score" min="1" max="5" step="0.5" placeholder="AP成绩">
                    <button type="button" class="remove-course" onclick="removeCourse(this)">删除</button>
                </div>
            </div>
            <button type="button" onclick="addAPCourse()">添加AP课程</button>
        </div>
    </div>

    <!-- IB课程成绩输入 -->
    <div id="ib_courses" class="course-input-group" style="display: none;">
        <div class="form-group">
            <label>IB课程成绩 (1-7):</label>
            <div class="course-inputs">
                <div class="course-input">
                    <input type="number" class="ib-score" min="1" max="7" step="0.5" placeholder="IB成绩">
                    <button type="button" class="remove-course" onclick="removeCourse(this)">删除</button>
                </div>
            </div>
            <button type="button" onclick="addIBCourse()">添加IB课程</button>
        </div>
    </div>

    <!-- A-Level课程成绩输入 -->
    <div id="a_level_courses" class="course-input-group" style="display: none;">
        <div class="form-group">
            <label>A-Level课程成绩 (A*-E):</label>
            <div class="course-inputs">
                <div class="course-input">
                    <select class="a-level-grade">
                        <option value="A*">A*</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                    </select>
                    <button type="button" class="remove-course" onclick="removeCourse(this)">删除</button>
                </div>
            </div>
            <button type="button" onclick="addALevelCourse()">添加A-Level课程</button>
        </div>
    </div>

    <!-- 国内课程成绩输入 -->
    <div id="domestic_courses" class="course-input-group" style="display: none;">
        <div class="form-group">
            <label>国内课程成绩 (0-100):</label>
            <div class="course-inputs">
                <div class="course-input">
                    <input type="number" class="domestic-score" min="0" max="100" placeholder="课程成绩">
                    <button type="button" class="remove-course" onclick="removeCourse(this)">删除</button>
                </div>
            </div>
            <button type="button" onclick="addDomesticCourse()">添加课程</button>
        </div>
    </div>

    <div class="form-group">
        <label for="university">选择大学:</label>
        <select id="university">
            <option value="princeton">普林斯顿大学</option>
            <option value="mit">麻省理工学院</option>
            <option value="harvard">哈佛大学</option>
            <option value="stanford">斯坦福大学</option>
            <option value="yale">耶鲁大学</option>
            <option value="chicago">芝加哥大学</option>
            <option value="jhu">约翰霍普金斯大学</option>
            <option value="penn">宾夕法尼亚大学</option>
            <option value="caltech">加州理工学院</option>
            <option value="duke">杜克大学</option>
            <option value="northwestern">西北大学</option>
            <option value="dartmouth">达特茅斯学院</option>
            <option value="brown">布朗大学</option>
            <option value="vanderbilt">范德堡大学</option>
            <option value="rice">莱斯大学</option>
            <option value="wustl">圣路易斯华盛顿大学</option>
            <option value="cornell">康奈尔大学</option>
            <option value="columbia">哥伦比亚大学</option>
            <option value="notre_dame">圣母大学</option>
            <option value="berkeley">加州大学伯克利分校</option>
            <option value="ucla">加州大学洛杉矶分校</option>
            <option value="cmu">卡内基梅隆大学</option>
            <option value="emory">埃默里大学</option>
            <option value="georgetown">乔治城大学</option>
            <option value="nyu">纽约大学</option>
            <option value="umich">密歇根大学安娜堡分校</option>
            <option value="usc">南加州大学</option>
            <option value="virginia">弗吉尼亚大学</option>
            <option value="tufts">塔夫茨大学</option>
            <option value="unc">北卡罗来纳大学教堂山分校</option>
        </select>
    </div>

    <button onclick="calculateProbability()">预测录取率</button>

    <div id="result"></div>

    <button id="historyButton" onclick="toggleHistory()">查看历史记录</button>
    <button class="clear-history" onclick="clearHistory()">清除历史记录</button>

    <table class="history-table" id="historyTable">
        <thead>
            <tr>
                <th>时间</th>
                <th>大学</th>
                <th>语言考试</th>
                <th>语言成绩</th>
                <th>GPA</th>
                <th>课程体系</th>
                <th>课程数量</th>
                <th>平均课程成绩</th>
                <th>预测录取率</th>
            </tr>
        </thead>
        <tbody id="historyBody">
        </tbody>
    </table>

    <script>
        // 添加语言考试切换功能
        document.getElementById('toefl_radio').addEventListener('change', function() {
            document.getElementById('toefl_group').style.display = 'block';
            document.getElementById('ielts_group').style.display = 'none';
            document.getElementById('toefl').required = true;
            document.getElementById('ielts').required = false;
        });

        document.getElementById('ielts_radio').addEventListener('change', function() {
            document.getElementById('toefl_group').style.display = 'none';
            document.getElementById('ielts_group').style.display = 'block';
            document.getElementById('toefl').required = false;
            document.getElementById('ielts').required = true;
        });

        const totalApplicants = 18000; // 总中国申请人数
        const universityData = {
            princeton: {
                admit: 18,
                minTOEFL: 110,
                avgTOEFL: 115,
                minIELTS: 7.5,
                avgIELTS: 8.0,
                minGPA: 3.9,
                avgGPA: 3.98,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            mit: {
                admit: 14,
                minTOEFL: 110,
                avgTOEFL: 115,
                minIELTS: 7.5,
                avgIELTS: 8.0,
                minGPA: 3.9,
                avgGPA: 3.98,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            harvard: {
                admit: 10,
                minTOEFL: 108,
                avgTOEFL: 113,
                minIELTS: 7.5,
                avgIELTS: 8.0,
                minGPA: 3.8,
                avgGPA: 3.97,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            stanford: {
                admit: 46,
                minTOEFL: 105,
                avgTOEFL: 111,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.8,
                avgGPA: 3.96,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            yale: {
                admit: 22,
                minTOEFL: 108,
                avgTOEFL: 113,
                minIELTS: 7.5,
                avgIELTS: 8.0,
                minGPA: 3.8,
                avgGPA: 3.97,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            chicago: {
                admit: 68,
                minTOEFL: 105,
                avgTOEFL: 110,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.8,
                avgGPA: 3.95,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            jhu: {
                admit: 91,
                minTOEFL: 105,
                avgTOEFL: 110,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.8,
                avgGPA: 3.95,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            penn: {
                admit: 45,
                minTOEFL: 105,
                avgTOEFL: 110,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.8,
                avgGPA: 3.95,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            caltech: {
                admit: 17,
                minTOEFL: 110,
                avgTOEFL: 115,
                minIELTS: 7.5,
                avgIELTS: 8.0,
                minGPA: 3.9,
                avgGPA: 3.98,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            duke: {
                admit: 57,
                minTOEFL: 105,
                avgTOEFL: 110,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.8,
                avgGPA: 3.95,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            northwestern: {
                admit: 66,
                minTOEFL: 105,
                avgTOEFL: 110,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.8,
                avgGPA: 3.95,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            dartmouth: {
                admit: 22,
                minTOEFL: 105,
                avgTOEFL: 110,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.8,
                avgGPA: 3.95,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            brown: {
                admit: 35,
                minTOEFL: 105,
                avgTOEFL: 110,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.8,
                avgGPA: 3.95,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            vanderbilt: {
                admit: 67,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            rice: {
                admit: 103,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            wustl: {
                admit: 234,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            cornell: {
                admit: 152,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            columbia: {
                admit: 31,
                minTOEFL: 105,
                avgTOEFL: 110,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.8,
                avgGPA: 3.95,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            notre_dame: {
                admit: 18,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            berkeley: {
                admit: 468,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            ucla: {
                admit: 304,
                minTOEFL: 95,
                avgTOEFL: 105,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.5,
                avgGPA: 3.85,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            cmu: {
                admit: 160,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            emory: {
                admit: 211,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            georgetown: {
                admit: 46,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            nyu: {
                admit: 120,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            umich: {
                admit: 136,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            usc: {
                admit: 576,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            virginia: {
                admit: 168,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            tufts: {
                admit: 45,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            },
            unc: {
                admit: 499,
                minTOEFL: 100,
                avgTOEFL: 108,
                minIELTS: 7.0,
                avgIELTS: 7.5,
                minGPA: 3.7,
                avgGPA: 3.9,
                curriculumWeight: {
                    ap: 1.0,
                    ib: 1.0,
                    a_level: 1.0,
                    domestic: 0.9,
                    other: 0.95
                }
            }
        };

        // 课程输入相关函数
        function updateCourseInputs() {
            const curriculum = document.getElementById('curriculum').value;
            document.querySelectorAll('.course-input-group').forEach(group => {
                group.style.display = 'none';
            });
            document.getElementById(`${curriculum}_courses`).style.display = 'block';
        }

        function addAPCourse() {
            const container = document.querySelector('#ap_courses .course-inputs');
            const div = document.createElement('div');
            div.className = 'course-input';
            div.innerHTML = `
                <input type="number" class="ap-score" min="1" max="5" step="0.5" placeholder="AP成绩">
                <button type="button" class="remove-course" onclick="removeCourse(this)">删除</button>
            `;
            container.appendChild(div);
        }

        function addIBCourse() {
            const container = document.querySelector('#ib_courses .course-inputs');
            const div = document.createElement('div');
            div.className = 'course-input';
            div.innerHTML = `
                <input type="number" class="ib-score" min="1" max="7" step="0.5" placeholder="IB成绩">
                <button type="button" class="remove-course" onclick="removeCourse(this)">删除</button>
            `;
            container.appendChild(div);
        }

        function addALevelCourse() {
            const container = document.querySelector('#a_level_courses .course-inputs');
            const div = document.createElement('div');
            div.className = 'course-input';
            div.innerHTML = `
                <select class="a-level-grade">
                    <option value="A*">A*</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                </select>
                <button type="button" class="remove-course" onclick="removeCourse(this)">删除</button>
            `;
            container.appendChild(div);
        }

        function addDomesticCourse() {
            const container = document.querySelector('#domestic_courses .course-inputs');
            const div = document.createElement('div');
            div.className = 'course-input';
            div.innerHTML = `
                <input type="number" class="domestic-score" min="0" max="100" placeholder="课程成绩">
                <button type="button" class="remove-course" onclick="removeCourse(this)">删除</button>
            `;
            container.appendChild(div);
        }

        function removeCourse(button) {
            button.parentElement.remove();
        }

        // 修改appendToLog函数，使用后端API
        async function appendToLog(data) {
            try {
                console.log('Sending prediction data:', data);
                const response = await fetch('http://localhost:3000/save-prediction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Failed to save prediction');
                }

                const result = await response.json();
                console.log('Server response:', result);
            } catch (err) {
                console.error('保存文件失败:', err);
            }
        }

        // 修改calculateProbability函数，在显示结果后自动记录到log.csv
        function calculateProbability() {
            // 获取用户输入
            const university = document.getElementById('university').value;
            const languageTest = document.querySelector('input[name="language_test"]:checked').value;
            const languageScore = languageTest === 'toefl' 
                ? parseFloat(document.getElementById('toefl').value)
                : parseFloat(document.getElementById('ielts').value);
            const gpa = parseFloat(document.getElementById('gpa').value);
            const curriculum = document.getElementById('curriculum').value;

            // 验证输入
            if (!university) {
                alert('请选择大学');
                return;
            }

            if (languageTest === 'toefl' && (isNaN(languageScore) || languageScore < 0 || languageScore > 120)) {
                alert('请输入有效的托福成绩（0-120）');
                return;
            }

            if (languageTest === 'ielts' && (isNaN(languageScore) || languageScore < 0 || languageScore > 9)) {
                alert('请输入有效的雅思成绩（0-9）');
                return;
            }

            if (isNaN(gpa) || gpa < 0 || gpa > 4.0) {
                alert('请输入有效的GPA（0-4.0）');
                return;
            }

            // 获取大学数据
            const selectedUniversity = universityData[university];
            if (!selectedUniversity) {
                alert("请选择有效的大学");
                return;
            }

            // 计算基础录取率
            const baseRate = selectedUniversity.admit / totalApplicants;

            // 标准化语言成绩
            let normalizedLanguageScore;
            if (languageTest === 'toefl') {
                normalizedLanguageScore = (languageScore - selectedUniversity.minTOEFL) / (selectedUniversity.avgTOEFL - selectedUniversity.minTOEFL);
            } else {
                normalizedLanguageScore = (languageScore - selectedUniversity.minIELTS) / (selectedUniversity.avgIELTS - selectedUniversity.minIELTS);
            }
            normalizedLanguageScore = Math.max(0, Math.min(1, normalizedLanguageScore));

            // 标准化GPA
            const normalizedGPA = (gpa - selectedUniversity.minGPA) / (selectedUniversity.avgGPA - selectedUniversity.minGPA);
            const normalizedGPAAdjusted = Math.max(0, Math.min(1, normalizedGPA));

            // 计算课程成绩影响
            let courseScoreImpact = 0;
            let courseCount = 0;
            let totalScore = 0;
            let validScores = 0;

            if (curriculum === 'ap') {
                document.querySelectorAll('.ap-score').forEach(input => {
                    if (input.value) {
                        totalScore += parseFloat(input.value);
                        validScores++;
                    }
                });
                courseCount = document.querySelectorAll('.ap-score').length;
            } else if (curriculum === 'ib') {
                document.querySelectorAll('.ib-score').forEach(input => {
                    if (input.value) {
                        totalScore += parseFloat(input.value);
                        validScores++;
                    }
                });
                courseCount = document.querySelectorAll('.ib-score').length;
            } else if (curriculum === 'a_level') {
                document.querySelectorAll('.a-level-grade').forEach(select => {
                    const grade = select.value;
                    const scoreMap = { 'A*': 5, 'A': 4, 'B': 3, 'C': 2, 'D': 1, 'E': 0 };
                    totalScore += scoreMap[grade];
                    validScores++;
                });
                courseCount = document.querySelectorAll('.a-level-grade').length;
            } else if (curriculum === 'domestic') {
                document.querySelectorAll('.domestic-score').forEach(input => {
                    if (input.value) {
                        const score = parseFloat(input.value);
                        // 将100分制转换为5分制
                        const convertedScore = (score / 100) * 5;
                        totalScore += convertedScore;
                        validScores++;
                    }
                });
                courseCount = document.querySelectorAll('.domestic-score').length;
            }

            // 如果没有有效课程成绩，使用默认值
            const avgCourseScore = validScores > 0 ? totalScore / validScores : 3.0; // 默认使用3.0
            courseScoreImpact = avgCourseScore / 5; // 转换为0-1范围

            // 计算课程数量加成
            const courseCountBonus = Math.min(0.5, (courseCount - 3) * 0.1);
            courseScoreImpact += courseCountBonus;

            // 计算最终概率
            const probability = baseRate * (
                0.3 * normalizedLanguageScore + // 语言成绩占30%
                0.3 * normalizedGPAAdjusted +  // GPA占30%
                0.3 * courseScoreImpact +      // 课程成绩占30%
                0.1                           // 基础分10%
            ) * 100;

            // 显示结果
            showResult(probability, university, baseRate);

            // 保存预测数据
            const predictionData = {
                timestamp: new Date(new Date().getTime() + 8 * 60 * 60 * 1000).toISOString(), // 转换为北京时间
                university: document.getElementById('university').options[document.getElementById('university').selectedIndex].text,
                languageTest: languageTest === 'toefl' ? '托福' : '雅思',
                languageScore: languageScore,
                gpa: gpa,
                curriculum: document.getElementById('curriculum').options[document.getElementById('curriculum').selectedIndex].text,
                courseCount: courseCount,
                avgCourseScore: avgCourseScore.toFixed(2),
                probability: Math.min(probability, 20)
            };

            appendToLog(predictionData);
        }

        function showResult(probability, university, baseRate) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            
            const uniName = document.getElementById('university')
                .options[document.getElementById('university').selectedIndex].text;
            
            resultDiv.innerHTML = `
                <div class="result-card">
                    <div class="result-detail">
                        <span class="result-label">预测录取率：</span>
                        <span class="result-value prediction-rate">${probability.toFixed(2)}%</span>
                    </div>
                    
                    <div class="result-detail">
                        <span class="result-label">目标学校：</span>
                        <span class="result-value">${uniName}</span>
                    </div>
                    
                    <div class="result-advice">
                        <strong>建议：</strong> ${getAdmissionAdvice(probability)}
                    </div>
                    
                    <div class="result-detail warning">
                        <strong>⚠️ 提示：</strong> 实际录取率可能受文书、推荐信、课外活动等因素影响
                    </div>
                </div>
            `;

            // 设置样式
            resultDiv.className = '';
            if (probability > baseRate * 3) resultDiv.classList.add('good');
            else if (probability > baseRate * 1.5) resultDiv.classList.add('medium');
            else resultDiv.classList.add('low');
        }

        function getAdmissionAdvice(prob) {
            if (prob > 5) return "属于高竞争力区间（前5%申请者）";
            if (prob > 2) return "需要出色软实力补充（前10%申请者）";
            if (prob > 0.5) return "建议搭配3-5所匹配院校申请";
            return "建议重点考虑匹配度更高的学校";
        }

        // 添加数据库相关代码
        let db;
        const dbName = "AdmissionPredictorDB";
        const dbVersion = 1;
        const storeName = "predictions";

        // 添加日志记录相关代码
        const logStoreName = "predictionLogs";

        // 初始化数据库
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);

                request.onerror = () => {
                    console.error("数据库打开失败");
                    reject(request.error);
                };

                request.onsuccess = () => {
                    db = request.result;
                    console.log("数据库打开成功");
                    resolve();
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        const store = db.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
                        store.createIndex("university", "university", { unique: false });
                        store.createIndex("timestamp", "timestamp", { unique: false });
                    }
                    if (!db.objectStoreNames.contains(logStoreName)) {
                        const logStore = db.createObjectStore(logStoreName, { keyPath: "id", autoIncrement: true });
                        logStore.createIndex("timestamp", "timestamp", { unique: false });
                    }
                };
            });
        }

        // 保存预测数据到数据库
        function saveToDB(data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], "readwrite");
                const store = transaction.objectStore(storeName);
                const request = store.add({
                    ...data,
                    timestamp: new Date().toISOString()
                });

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // 获取所有预测数据
        function getAllPredictions() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], "readonly");
                const store = transaction.objectStore(storeName);
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // 记录预测日志
        function logPrediction(data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([logStoreName], "readwrite");
                const store = transaction.objectStore(logStoreName);
                const request = store.add({
                    ...data,
                    timestamp: new Date().toISOString()
                });

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // 获取所有日志数据
        function getAllLogs() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([logStoreName], "readonly");
                const store = transaction.objectStore(logStoreName);
                const request = store.getAll();

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // 修改原有的savePrediction函数
        function savePrediction(data) {
            // 保存到localStorage（用于即时显示）
            let history = JSON.parse(localStorage.getItem('predictionHistory') || '[]');
            history.push({
                timestamp: new Date().toLocaleString(),
                ...data
            });
            localStorage.setItem('predictionHistory', JSON.stringify(history));

            // 保存到IndexedDB
            saveToDB(data).catch(error => {
                console.error("保存到数据库失败:", error);
            });
        }

        // 修改loadHistory函数
        function loadHistory() {
            getAllPredictions().then(predictions => {
                const tbody = document.getElementById('historyBody');
                tbody.innerHTML = '';
                
                predictions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .forEach(record => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(record.timestamp).toLocaleString()}</td>
                            <td>${record.university}</td>
                            <td>${record.languageTest}</td>
                            <td>${record.languageScore}</td>
                            <td>${record.gpa}</td>
                            <td>${record.curriculum}</td>
                            <td>${record.courseCount}</td>
                            <td>${record.avgCourseScore}</td>
                            <td>${record.probability.toFixed(2)}%</td>
                        `;
                        tbody.appendChild(row);
                    });
            });
        }

        // 修改clearHistory函数
        function clearHistory() {
            if (confirm('确定要清除所有历史记录吗？')) {
                // 清除localStorage
                localStorage.removeItem('predictionHistory');
                document.getElementById('historyBody').innerHTML = '';

                // 清除IndexedDB
                const transaction = db.transaction([storeName], "readwrite");
                const store = transaction.objectStore(storeName);
                store.clear();
            }
        }

        // 初始化数据库
        initDB().catch(error => {
            console.error("数据库初始化失败:", error);
        });

        // 添加历史记录相关函数
        function toggleHistory() {
            const table = document.getElementById('historyTable');
            if (table.style.display === 'none') {
                loadHistory();
                table.style.display = 'table';
            } else {
                table.style.display = 'none';
            }
        }
    </script>
</body>
</html>